"use strict";geotab.addin.startStop=function(){var d,o,r,l,c,s,u,m,a,D=2e3,S=.1,f=function(n){a=n,d.call("Get",{typeName:"Device",search:{groups:o.getGroupFilter(),fromDate:(new Date).toISOString()},resultsLimit:1e3},function(e){var t=e.sort(function(e,t){return e.name.toLowerCase().localeCompare(t.name.toLowerCase())}).map(function(e){return{name:e.name,id:e.id}});a===n&&a(t)},function(e){alert(e)})};function g(n,a,i){return new Promise(function(e,t){d.call("Get",{typeName:"Trip",search:{deviceSearch:{id:n},fromDate:a,toDate:i},resultsLimit:1e4},e,t)})}function h(e,t,n,a){var i=t/1e3/60*n;a=a||"",r=document.getElementById("stopStart-times"+a),l=document.getElementById("stopStart-idling"+a),c=document.getElementById("stopStart-fuel"+a),-1===e?(r.innerText="-",l.innerText="-:--",c.innerText="-"):(r.innerText=Math.round(e),l.innerText=function(e){var t=parseInt(e,10),n=Math.floor(t/3600),a=Math.floor((t-3600*n)/60);a<10&&(a="0"+a);return n+":"+a}(t/1e3),c.innerText=Math.round(i*s*100)/100)}function p(e,t,n){h(e,t,n,"-annual")}function v(){h(-1),p(-1),""!==this.value&&function(o){document.getElementById("stopStart-vehicleSelect").disabled=!0;var r=new Date,l=new Date;l.setDate(r.getDate()-1);var c=0,s=0,u=0;t(30,function(a){var t,n,i;(t=o,n=l,i=r,new Promise(function(v,e){d.multiCall([["Get",{typeName:"StatusData",search:{deviceSearch:{id:t},fromDate:n.toISOString(),toDate:i.toISOString()},resultsLimit:5e4}],["Get",{typeName:"LogRecord",search:{deviceSearch:{id:t},fromDate:n,toDate:i},resultsLimit:5e4}]],function(e){var t,n,a,i=e[0],o=e[1],r=!1,l=!1,c=!1,s=null,u=null,d=null,m=0,f=0,g=[],h=i.filter(function(e){switch(e.diagnostic.id){case"DiagnosticVehicleActiveId":case"DiagnosticEngineSpeedId":case"DiagnosticTotalTripIdleFuelUsedId":return!0;default:return!1}});for((h=(h=h.concat(o)).map(function(e){return e.dateTime=new Date(e.dateTime),e})).sort(function(e,t){return e.dateTime-t.dateTime}),n=0;n<h.length;n++){if((t=h[n]).diagnostic)switch(t.diagnostic.id){case"DiagnosticVehicleActiveId":r=1===t.data;break;case"DiagnosticEngineSpeedId":l=0<t.data;break;case"DiagnosticTotalTripIdleFuelUsedId":f+=t.data}else c=0!==t.speed;if(!c&&l&&null==d&&(d=t.dateTime),null===d||!c&&l||(m+=t.dateTime-d,d=null),!r||l||a){if(a&&(!r||l)){var p=(u=t.dateTime)-s;D<p&&g.push({fromDate:s,duration:u-s}),a=!1}}else a=!0,s=t.dateTime}v({fuelUsedPerMinuteIdling:0<m&&S<f?f/(m/1e3/60):0,stopStarts:g})},e)})).then(function(e){var t=e.stopStarts,n=e.fuelUsedPerMinuteIdling;0<(s+=t.length)&&(t.forEach(function(e){c+=e.duration}),0<n&&(u=0===u?n:(u+n)/2),h(s,c,u)),l.setDate(l.getDate()-1),r.setDate(r.getDate()-1),a.next()})},function(){l=new Date,r=new Date,l.setDate(l.getDate()-30),g(o,l,r).then(function(e){var n,a,i=0;e.forEach(function(e){i+=e.distance}),0<i?(p((n=s/i)*i,(a=c/i)*i,u),t(11,function(t){g(o,l,r).then(function(e){e.forEach(function(e){i+=e.distance}),p(n*i,a*i,u),l.setDate(l.getDate()-30),r.setDate(r.getDate()-30),t.next()})},function(){document.getElementById("stopStart-vehicleSelect").disabled=!1})):document.getElementById("stopStart-vehicleSelect").disabled=!1})})}(this.value)}function t(e,t,n){var a=0,i=!1,o={next:function(){i||(a<e?(a++,t(o)):(i=!0,n()))},iteration:function(){return a-1},break:function(){i=!0,n()}};return o.next(),o}return{initialize:function(e,t,n){d=e,o=t,m=document.getElementById("startStop"),o.translate&&o.translate(m||""),n()},focus:function(e,t){var n,a,i;d=e,o=t,h(-1),n=function(){var n;n=function(){document.getElementById("stopStart-volume-label").innerHTML=u,document.getElementById("stopStart-volume-label-annual").innerHTML=u,console.log("updateDashboardRegionalUnits"),m.style.display="block"},d.getSession(function(e){var t=e.userName;d.call("Get",{typeName:"User",search:{name:t}},function(e){if(0===e.length)throw new Error("Unable to find currently logged on user.");var t=e[0];switch(t.fuelEconomyUnit){case"LitersPer100Km":case"KmPerLiter":s=1,u=o.translate("Liters");break;case"MPGUS":s=1/3.785411784,u=o.translate("Gallons (US)");break;case"MPGImperial":s=1/4.54609,u=o.translate("Gallons (UK)");break;default:s=1,u=o.translate("Liters")}console.log(t.isMetric),console.log(t.fuelEconomyUnit),console.log(t.language),console.log(t.dateFormat),console.log(t.timeZoneId),n()},function(e){throw"Error while trying to load currently logged on user. "+e})})},(i=document.getElementById("stopStart-vehicleSelect")).innerHTML="",i.removeEventListener("change",v),i.appendChild(((a=document.createElement("option")).default=!0,a.selected=!0,a.value="",a.textContent=o.translate("Select a vehicle..."),a)),f(function(e){e.forEach(function(e){var t=document.createElement("option");t.value=e.id,t.textContent=e.name,i.appendChild(t)}),i.addEventListener("change",v),n()})},blur:function(){m.style.display="none"}}};